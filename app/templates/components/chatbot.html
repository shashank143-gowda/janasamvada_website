<div class="chatbot-widget" id="chatbot-widget">
    <div class="chatbot-toggle" id="chatbot-toggle">
        <i class="fas fa-comment-dots"></i>
    </div>
    
    <div class="chatbot-container" id="chatbot-container">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <i class="fas fa-robot me-2"></i>
                <span>JanSamvaad Assistant</span>
            </div>
            <div class="chatbot-actions">
                <select id="chatbot-language" class="chatbot-language-selector">
                    <option value="en" selected>English</option>
                    <option value="hi">हिंदी</option>
                    <option value="kn">ಕನ್ನಡ</option>
                    <option value="ta">தமிழ்</option>
                    <option value="te">తెలుగు</option>
                    <option value="ml">മലയാളം</option>
                    <option value="mr">मराठी</option>
                    <option value="bn">বাংলা</option>
                    <option value="gu">ગુજરાતી</option>
                    <option value="pa">ਪੰਜਾਬੀ</option>
                </select>
                <button id="chatbot-close" class="chatbot-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="chatbot-messages" id="chatbot-messages">
            <div class="message message-bot">
                <div class="message-content">
                    Hello! I'm your JanSamvaad Assistant. How can I help you today?
                </div>
                <div class="message-time">Just now</div>
            </div>
        </div>
        
        <div class="chatbot-input">
            <button id="chatbot-mic" class="chatbot-mic">
                <i class="fas fa-microphone"></i>
            </button>
            <input type="text" id="chatbot-message" placeholder="Type your message...">
            <button id="chatbot-send" class="chatbot-send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<style>
    .chatbot-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .chatbot-toggle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color, #6c5ce7), var(--secondary-color, #00cec9));
        color: black;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        box-shadow: var(--neon-glow, 0 0 10px rgba(108, 92, 231, 0.5), 0 0 20px rgba(108, 92, 231, 0.3));
        transition: all 0.3s ease;
    }
    
    .chatbot-toggle:hover {
        transform: scale(1.1);
    }
    
    .chatbot-container {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        height: 500px;
        background-color: var(--card-bg, #16213e);
        border-radius: 15px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        display: none;
        border: var(--card-border, 1px solid rgba(255, 255, 255, 0.05));
    }
    
    .chatbot-header {
        background: linear-gradient(135deg, var(--primary-color, #6c5ce7), var(--secondary-color, #00cec9));
        color: black;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }
    
    .chatbot-title {
        display: flex;
        align-items: center;
        font-weight: 600;
    }
    
    .chatbot-actions {
        display: flex;
        align-items: center;
    }
    
    .chatbot-language-selector {
        background-color: rgba(0, 0, 0, 0.2);
        border: none;
        color: black;
        padding: 5px;
        border-radius: 5px;
        margin-right: 10px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .chatbot-language-selector option {
        color: #333;
        background-color: white;
    }
    
    .chatbot-close {
        background: none;
        border: none;
        color: black;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }
    
    .chatbot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: var(--medium-dark-color, #2a2a42);
    }
    
    .message {
        margin-bottom: 15px;
        max-width: 80%;
    }
    
    .message-bot {
        margin-right: auto;
    }
    
    .message-user {
        margin-left: auto;
    }
    
    .message-content {
        padding: 10px 15px;
        border-radius: 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .message-bot .message-content {
        background-color: #f8f9fa; /* Light background for better contrast with black text */
        color: #000000; /* Black text for better readability */
        border-top-left-radius: 0;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .message-user .message-content {
        background: linear-gradient(135deg, var(--primary-color, #6c5ce7), var(--secondary-color, #00cec9));
        color: #000000;
        font-weight: 500;
        border-top-right-radius: 0;
    }
    
    .message-time {
        font-size: 10px;
        color: var(--text-muted, #a0a0a0);
        margin-top: 5px;
    }
    
    .chatbot-input {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: var(--card-bg, #16213e);
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .chatbot-mic {
        background: none;
        border: none;
        color: var(--text-muted, #a0a0a0);
        font-size: 18px;
        cursor: pointer;
        padding: 5px 10px;
        transition: all 0.3s ease;
    }
    
    .chatbot-mic:hover {
        color: var(--primary-color, #6c5ce7);
        text-shadow: var(--neon-text-shadow, 0 0 5px rgba(108, 92, 231, 0.7));
    }
    
    .chatbot-mic.listening {
        color: #e74c3c;
        animation: pulse 1.5s infinite;
    }
    
    #chatbot-message {
        flex: 1;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 20px;
        background-color: var(--medium-dark-color, #2a2a42);
        color: var(--text-color, #e2e2e2);
    }
    
    #chatbot-message:focus {
        outline: none;
    }
    
    .chatbot-send {
        background: none;
        border: none;
        color: var(--primary-color, #6c5ce7);
        font-size: 18px;
        cursor: pointer;
        padding: 5px 10px;
        transition: all 0.3s ease;
    }
    
    .chatbot-send:hover {
        color: var(--secondary-color, #00cec9);
        text-shadow: var(--neon-text-shadow, 0 0 5px rgba(108, 92, 231, 0.7));
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.2);
        }
        100% {
            transform: scale(1);
        }
    }
    
    @media (max-width: 576px) {
        .chatbot-container {
            width: 300px;
            height: 450px;
            bottom: 70px;
        }
    }
    
    /* Ensure all paragraphs and text in the chatbot have black text */
    .chatbot-container p,
    .chatbot-container div,
    .message-content,
    .message-bot .message-content,
    .message-user .message-content {
        color: #000000 !important;
    }
    
    /* Exception for message time which should remain muted */
    .message-time {
        color: var(--text-muted, #a0a0a0) !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chatbot elements
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotMessage = document.getElementById('chatbot-message');
        const chatbotSend = document.getElementById('chatbot-send');
        const chatbotMic = document.getElementById('chatbot-mic');
        const chatbotLanguage = document.getElementById('chatbot-language');
        
        // Dhwani API configuration
        const DHWANI_API = {
            key: "shashanksmv511@gmail.com_dwani",
            baseUrl: "https://dwani-dwani-api.hf.space"
        };
        
        // Language voice mapping
        const LANGUAGE_VOICES = {
            'en': 'en-US',
            'hi': 'hi-IN',
            'kn': 'kn-IN',
            'ta': 'ta-IN',
            'te': 'te-IN',
            'ml': 'ml-IN',
            'mr': 'mr-IN',
            'bn': 'bn-IN',
            'gu': 'gu-IN',
            'pa': 'pa-IN'
        };
        
        let isListening = false;
        let recognition;
        let chatContext = [];
        
        // Initialize speech recognition
        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = function() {
                    isListening = true;
                    chatbotMic.classList.add('listening');
                };
                
                recognition.onend = function() {
                    isListening = false;
                    chatbotMic.classList.remove('listening');
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    chatbotMessage.value = transcript;
                    sendMessage();
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    isListening = false;
                    chatbotMic.classList.remove('listening');
                };
            } catch (error) {
                console.error('Speech recognition not supported', error);
                chatbotMic.disabled = true;
                chatbotMic.title = 'Speech recognition not supported in this browser';
            }
        }
        
        // Toggle speech recognition
        function toggleSpeechRecognition() {
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.lang = LANGUAGE_VOICES[chatbotLanguage.value];
                    recognition.start();
                } catch (error) {
                    console.error('Failed to start speech recognition', error);
                }
            }
        }
        
        // Get current time string
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Add message to chat
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isUser ? 'message-user' : 'message-bot');
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            contentDiv.style.color = '#000000'; // Force black text color
            contentDiv.textContent = text;
            
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.textContent = getCurrentTime();
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            
            chatbotMessages.appendChild(messageDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        // Send message to chatbot
        async function sendMessage() {
            const message = chatbotMessage.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, true);
            
            // Clear input
            chatbotMessage.value = '';
            
            try {
                // Call chatbot API
                const response = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        language: chatbotLanguage.value,
                        context: chatContext
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Add bot response to chat
                    addMessage(data.response);
                    
                    // Update context
                    chatContext.push({
                        role: 'user',
                        content: message
                    });
                    
                    chatContext.push({
                        role: 'assistant',
                        content: data.response
                    });
                    
                    // Limit context size
                    if (chatContext.length > 10) {
                        chatContext = chatContext.slice(-10);
                    }
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.');
                }
            } catch (error) {
                console.error('Chatbot error:', error);
                addMessage('Sorry, I encountered an error. Please try again.');
            }
        }
        
        // Toggle chatbot visibility
        function toggleChatbot() {
            if (chatbotContainer.style.display === 'flex') {
                chatbotContainer.style.display = 'none';
            } else {
                chatbotContainer.style.display = 'flex';
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }
        }
        
        // Initialize
        initSpeechRecognition();
        
        // Event listeners
        chatbotToggle.addEventListener('click', toggleChatbot);
        chatbotClose.addEventListener('click', toggleChatbot);
        
        chatbotSend.addEventListener('click', sendMessage);
        
        chatbotMessage.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        chatbotMic.addEventListener('click', toggleSpeechRecognition);
        
        chatbotLanguage.addEventListener('change', function() {
            // Add a system message about language change
            addMessage(`Language changed to ${chatbotLanguage.options[chatbotLanguage.selectedIndex].text}`);
        });
    });
</script>