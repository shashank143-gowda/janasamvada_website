{% extends 'base.html' %}

{% block title %}Public Services - JanSamvaad{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="services-hero position-relative overflow-hidden">
    <!-- Background with overlay -->
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-primary" style="opacity: 0.9; background: linear-gradient(135deg, #3498db, #1abc9c);"></div>
    
    <!-- Wave shape divider -->
    <div class="position-absolute bottom-0 start-0 w-100">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none" style="width: 100%; height: 80px;">
            <path fill="#ffffff" fill-opacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
        </svg>
    </div>
    
    <div class="container position-relative py-5">
        <div class="row align-items-center py-5">
            <div class="col-lg-6 text-white mb-5 mb-lg-0">
                <h1 class="display-4 fw-bold mb-3 animate__animated animate__fadeInUp">Essential Services Near You</h1>
                <p class="lead mb-4 animate__animated animate__fadeInUp animate__delay-1s">
                    Find hospitals, police stations, government offices and other essential services in your area with real-time information and directions.
                </p>
                <div class="d-flex flex-wrap gap-3 animate__animated animate__fadeInUp animate__delay-2s">
                    <button class="btn btn-light btn-lg px-4 d-flex align-items-center" id="useLocationBtn">
                        <i class="fas fa-location-arrow me-2"></i> Use My Location
                    </button>
                    <button class="btn btn-outline-light btn-lg px-4 d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#searchModal">
                        <i class="fas fa-search me-2"></i> Search Area
                    </button>
                </div>
            </div>
            <div class="col-lg-6 animate__animated animate__fadeInRight">
                <div class="position-relative">
                    <img src="{{ url_for('static', filename='img/services-hero.jpg') }}" alt="Public Services" class="img-fluid rounded-4 shadow-lg" style="transform: perspective(1000px) rotateY(-15deg) rotateX(5deg); transition: all 0.5s ease;">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Services Categories Section -->
<section class="py-5">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="fw-bold">Browse Services by Category</h2>
            <p class="text-muted">Select a category to find specific services</p>
        </div>
        
        <div class="row g-4 justify-content-center">
            <!-- Health -->
            <div class="col-6 col-md-4 col-lg-2">
                <div class="category-card text-center p-4 h-100" data-category="health">
                    <div class="category-icon mb-3">
                        <i class="fas fa-hospital text-danger"></i>
                    </div>
                    <h5 class="category-title">Health</h5>
                </div>
            </div>
            
            <!-- Education -->
            <div class="col-6 col-md-4 col-lg-2">
                <div class="category-card text-center p-4 h-100" data-category="education">
                    <div class="category-icon mb-3">
                        <i class="fas fa-school text-warning"></i>
                    </div>
                    <h5 class="category-title">Education</h5>
                </div>
            </div>
            
            <!-- Government -->
            <div class="col-6 col-md-4 col-lg-2">
                <div class="category-card text-center p-4 h-100" data-category="government">
                    <div class="category-icon mb-3">
                        <i class="fas fa-landmark text-primary"></i>
                    </div>
                    <h5 class="category-title">Government</h5>
                </div>
            </div>
            
            <!-- Security -->
            <div class="col-6 col-md-4 col-lg-2">
                <div class="category-card text-center p-4 h-100" data-category="security">
                    <div class="category-icon mb-3">
                        <i class="fas fa-shield-alt text-info"></i>
                    </div>
                    <h5 class="category-title">Security</h5>
                </div>
            </div>
            
            <!-- Transport -->
            <div class="col-6 col-md-4 col-lg-2">
                <div class="category-card text-center p-4 h-100" data-category="transport">
                    <div class="category-icon mb-3">
                        <i class="fas fa-bus text-success"></i>
                    </div>
                    <h5 class="category-title">Transport</h5>
                </div>
            </div>
            
            <!-- Financial -->
            <div class="col-6 col-md-4 col-lg-2">
                <div class="category-card text-center p-4 h-100" data-category="financial">
                    <div class="category-icon mb-3">
                        <i class="fas fa-university text-secondary"></i>
                    </div>
                    <h5 class="category-title">Financial</h5>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Services Results Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-6">
                <h2 class="fw-bold mb-0">Nearby Services</h2>
                <p class="text-muted" id="currentLocationDisplay">
                    <i class="fas fa-location-crosshairs me-2"></i> Set your location to find services
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-outline-primary mb-2 mb-md-0" id="refreshLocationBtn">
                    <i class="fas fa-sync-alt me-2"></i> Refresh Location
                </button>
                <button class="btn btn-primary mb-2 mb-md-0" id="askAiBtn">
                    <i class="fas fa-robot me-2"></i> Ask AI Assistant
                </button>
            </div>
        </div>
        
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <label for="serviceTypeFilter" class="form-label">Service Type</label>
                        <select class="form-select" id="serviceTypeFilter">
                            <option value="all" selected>All Services</option>
                            <option value="health">Health</option>
                            <option value="education">Education</option>
                            <option value="government">Government</option>
                            <option value="security">Security</option>
                            <option value="transport">Transport</option>
                            <option value="financial">Financial</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <label for="radiusRange" class="form-label">Distance (km): <span id="radiusValue">10</span></label>
                        <input type="range" class="form-range" id="radiusRange" min="1" max="50" value="10">
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-primary w-100" id="applyFiltersBtn">
                            <i class="fas fa-filter me-2"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info d-none" id="loadingAlert">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Searching for services near you...</div>
            </div>
        </div>
        
        <div class="mb-4 d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-primary rounded-pill" id="resultsCount">0 results</span>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-primary active" id="listViewBtn">
                    <i class="fas fa-list"></i>
                </button>
                <button class="btn btn-outline-primary" id="mapViewBtn">
                    <i class="fas fa-map-marked-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <!-- List View -->
                <div id="servicesListView">
                    <div class="alert alert-primary mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-info-circle fa-2x"></i>
                            </div>
                            <div>
                                <h5 class="alert-heading">Find Essential Services</h5>
                                <p class="mb-0">Use your current location or search for an area to find nearby services. Filter by type and distance to narrow your results.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="servicesContainer" class="row g-4"></div>
                    
                    <div class="alert alert-warning d-none" id="noResultsAlert">
                        <i class="fas fa-exclamation-circle me-2"></i> No services found in this area. Try increasing the distance or changing filters.
                    </div>
                </div>
                
                <!-- Map View -->
                <div id="servicesMapView" class="d-none">
                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="card-body p-0">
                            <div id="servicesMap" style="height: 600px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Service Detail Modal -->
<div class="modal fade" id="serviceDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceDetailTitle">Service Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="serviceDetailContent">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="serviceDirectionsBtn" target="_blank">
                    <i class="fas fa-directions me-2"></i> Get Directions
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Search Location Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Search Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="locationSearch" class="form-label">Enter a location</label>
                    <input type="text" class="form-control" id="locationSearch" placeholder="City, district, or landmark">
                </div>
                <div id="searchResults" class="list-group"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="searchLocationBtn">Search</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .services-hero {
        min-height: 500px;
        display: flex;
        align-items: center;
    }
    
    .category-card {
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }
    
    .category-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .service-card {
        border-radius: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        border: none;
    }
    
    .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.1);
    }
    
    .service-type-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    
    .service-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .service-address, .service-contact {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .service-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .service-distance {
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    #serviceDetailMap {
        height: 300px;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .bg-health {
        background-color: #e74c3c;
    }
    
    .bg-education {
        background-color: #f39c12;
    }
    
    .bg-government {
        background-color: #3498db;
    }
    
    .bg-security {
        background-color: #2ecc71;
    }
    
    .bg-transport {
        background-color: #9b59b6;
    }
    
    .bg-financial {
        background-color: #1abc9c;
    }
    
    .bg-other {
        background-color: #95a5a6;
    }
    
    /* Custom map controls */
    .map-control {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        margin: 10px;
        padding: 10px;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
    }
    
    .map-legend {
        position: absolute;
        bottom: 30px;
        right: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        padding: 10px;
        max-width: 200px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDf8fmG-LH14KqvPA33y-ZCKqBFhmWzD0s&libraries=places"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const useLocationBtn = document.getElementById('useLocationBtn');
        const refreshLocationBtn = document.getElementById('refreshLocationBtn');
        const currentLocationDisplay = document.getElementById('currentLocationDisplay');
        const searchLocationBtn = document.getElementById('searchLocationBtn');
        const locationSearch = document.getElementById('locationSearch');
        const searchResults = document.getElementById('searchResults');
        const searchModal = new bootstrap.Modal(document.getElementById('searchModal'));
        const radiusRange = document.getElementById('radiusRange');
        const radiusValue = document.getElementById('radiusValue');
        const serviceTypeFilter = document.getElementById('serviceTypeFilter');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const servicesContainer = document.getElementById('servicesContainer');
        const loadingAlert = document.getElementById('loadingAlert');
        const noResultsAlert = document.getElementById('noResultsAlert');
        const listViewBtn = document.getElementById('listViewBtn');
        const mapViewBtn = document.getElementById('mapViewBtn');
        const servicesListView = document.getElementById('servicesListView');
        const servicesMapView = document.getElementById('servicesMapView');
        const askAiBtn = document.getElementById('askAiBtn');
        const resultsCount = document.getElementById('resultsCount');
        const categoryCards = document.querySelectorAll('.category-card');
        
        // State
        let currentLocation = null;
        let currentRadius = 10;
        let currentServiceType = 'all';
        let servicesData = [];
        let map = null;
        let markers = [];
        let autocomplete = null;
        let infoWindow = null;
        
        // Initialize
        initializeMap();
        initializeAutocomplete();
        
        // Event Listeners
        useLocationBtn.addEventListener('click', function() {
            if (navigator.geolocation) {
                loadingAlert.classList.remove('d-none');
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        reverseGeocode(currentLocation);
                        fetchServices();
                    },
                    function(error) {
                        loadingAlert.classList.add('d-none');
                        alert('Error getting your location: ' + getGeolocationErrorMessage(error));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        });
        
        refreshLocationBtn.addEventListener('click', function() {
            if (currentLocation) {
                fetchServices();
            } else {
                useLocationBtn.click();
            }
        });
        
        radiusRange.addEventListener('input', function() {
            currentRadius = parseInt(this.value);
            radiusValue.textContent = currentRadius;
        });
        
        serviceTypeFilter.addEventListener('change', function() {
            currentServiceType = this.value;
        });
        
        categoryCards.forEach(card => {
            card.addEventListener('click', function() {
                const category = this.dataset.category;
                serviceTypeFilter.value = category;
                currentServiceType = category;
                
                // Scroll to results section
                document.querySelector('.bg-light').scrollIntoView({
                    behavior: 'smooth'
                });
                
                if (currentLocation) {
                    fetchServices();
                } else {
                    useLocationBtn.click();
                }
            });
        });
        
        applyFiltersBtn.addEventListener('click', fetchServices);
        
        listViewBtn.addEventListener('click', function() {
            listViewBtn.classList.add('active');
            mapViewBtn.classList.remove('active');
            servicesListView.classList.remove('d-none');
            servicesMapView.classList.add('d-none');
        });
        
        mapViewBtn.addEventListener('click', function() {
            mapViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            servicesMapView.classList.remove('d-none');
            servicesListView.classList.add('d-none');
            
            // Refresh map
            if (map) {
                google.maps.event.trigger(map, 'resize');
                if (currentLocation) {
                    map.setCenter({lat: currentLocation.lat, lng: currentLocation.lng});
                }
            }
        });
        
        askAiBtn.addEventListener('click', function() {
            // Trigger chatbot with context about services
            if (window.openChatbot) {
                window.openChatbot("I need help finding public services near me");
            } else {
                alert("AI Assistant is not available. Please try again later.");
            }
        });
        
        searchLocationBtn.addEventListener('click', function() {
            const place = autocomplete.getPlace();
            if (place && place.geometry) {
                currentLocation = {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng()
                };
                
                currentLocationDisplay.innerHTML = `
                    <div>
                        <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                        <span>${place.formatted_address || place.name}</span>
                    </div>
                `;
                
                searchModal.hide();
                fetchServices();
            } else {
                alert('Please select a location from the dropdown');
            }
        });
        
        // Functions
        function getGeolocationErrorMessage(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return "User denied the request for geolocation.";
                case error.POSITION_UNAVAILABLE:
                    return "Location information is unavailable.";
                case error.TIMEOUT:
                    return "The request to get user location timed out.";
                case error.UNKNOWN_ERROR:
                    return "An unknown error occurred.";
                default:
                    return "Error getting location.";
            }
        }
        
        function reverseGeocode(location) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({'location': location}, function(results, status) {
                if (status === 'OK' && results[0]) {
                    currentLocationDisplay.innerHTML = `
                        <div>
                            <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                            <span>${results[0].formatted_address}</span>
                        </div>
                    `;
                } else {
                    currentLocationDisplay.innerHTML = `
                        <div>
                            <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                            <span>Lat: ${location.lat.toFixed(6)}, Lng: ${location.lng.toFixed(6)}</span>
                        </div>
                    `;
                }
            });
        }
        
        function initializeAutocomplete() {
            autocomplete = new google.maps.places.Autocomplete(locationSearch, {
                types: ['geocode'],
                componentRestrictions: { country: 'in' }
            });
        }
        
        function fetchServices() {
            if (!currentLocation) {
                alert('Please set your location first');
                return;
            }
            
            loadingAlert.classList.remove('d-none');
            noResultsAlert.classList.add('d-none');
            servicesContainer.innerHTML = '';
            clearMarkers();
            
            const url = `/services_bp/api/services/nearby?lat=${currentLocation.lat}&lng=${currentLocation.lng}&radius=${currentRadius}${currentServiceType !== 'all' ? `&type=${currentServiceType}` : ''}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    loadingAlert.classList.add('d-none');
                    
                    if (data.success && data.services.length > 0) {
                        servicesData = data.services;
                        displayServices(servicesData);
                        resultsCount.textContent = `${servicesData.length} results`;
                    } else {
                        noResultsAlert.classList.remove('d-none');
                        resultsCount.textContent = '0 results';
                    }
                })
                .catch(error => {
                    console.error('Error fetching services:', error);
                    loadingAlert.classList.add('d-none');
                    alert('Error fetching services. Please try again.');
                });
        }
        
        function displayServices(services) {
            servicesContainer.innerHTML = '';
            
            services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'col-md-6 col-lg-4';
                serviceCard.innerHTML = `
                    <div class="card service-card shadow-sm h-100">
                        <div class="service-type-icon bg-${service.type}">
                            ${getServiceTypeIcon(service.type)}
                        </div>
                        <div class="card-body">
                            <h5 class="service-title">${service.name}</h5>
                            <div class="service-address">
                                <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                                ${service.address}
                            </div>
                            <div class="service-contact">
                                <i class="fas fa-phone me-2 text-muted"></i>
                                ${service.contact || 'Not available'}
                            </div>
                            <div class="service-footer">
                                <span class="service-distance">
                                    <i class="fas fa-route me-1 text-primary"></i>
                                    ${service.distance.toFixed(1)} km
                                </span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1 view-details-btn" data-service-id="${service.id}">
                                        <i class="fas fa-info-circle me-1"></i> Details
                                    </button>
                                    <a href="${service.map_link}" class="btn btn-sm btn-primary" target="_blank">
                                        <i class="fas fa-directions me-1"></i> Directions
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                servicesContainer.appendChild(serviceCard);
            });
            
            // Add event listeners to view details buttons
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const serviceId = parseInt(this.dataset.serviceId);
                    const service = servicesData.find(s => s.id === serviceId);
                    if (service) {
                        showServiceDetails(service);
                    }
                });
            });
            
            // Add markers to map
            addMarkersToMap(services);
        }
        
        function getServiceTypeIcon(type) {
            switch(type) {
                case 'health':
                    return '<i class="fas fa-hospital"></i>';
                case 'education':
                    return '<i class="fas fa-school"></i>';
                case 'government':
                    return '<i class="fas fa-landmark"></i>';
                case 'security':
                    return '<i class="fas fa-shield-alt"></i>';
                case 'transport':
                    return '<i class="fas fa-bus"></i>';
                case 'financial':
                    return '<i class="fas fa-university"></i>';
                default:
                    return '<i class="fas fa-building"></i>';
            }
        }
        
        function showServiceDetails(service) {
            const modal = new bootstrap.Modal(document.getElementById('serviceDetailModal'));
            const modalTitle = document.getElementById('serviceDetailTitle');
            const modalContent = document.getElementById('serviceDetailContent');
            const directionsBtn = document.getElementById('serviceDirectionsBtn');
            
            modalTitle.textContent = service.name;
            directionsBtn.href = service.map_link;
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-4">
                            <div id="serviceDetailMap"></div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="service-type-icon bg-${service.type} me-3" style="position: static; width: 40px; height: 40px; font-size: 1.2rem;">
                                ${getServiceTypeIcon(service.type)}
                            </div>
                            <div>
                                <div class="text-muted">Service Type</div>
                                <div class="fw-bold">${service.type.charAt(0).toUpperCase() + service.type.slice(1)}</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3 text-primary" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                <i class="fas fa-route"></i>
                            </div>
                            <div>
                                <div class="text-muted">Distance</div>
                                <div class="fw-bold">${service.distance.toFixed(1)} kilometers away</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Contact Information</h6>
                        <div class="mb-3">
                            <div class="text-muted mb-1">Address</div>
                            <div>${service.address}</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-muted mb-1">Phone</div>
                            <div>${service.contact || 'Not available'}</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-muted mb-1">Hours</div>
                            <div>${service.hours || 'Not specified'}</div>
                        </div>
                        <div>
                            <div class="text-muted mb-1">Additional Information</div>
                            <div>${service.description || 'No additional information available.'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
            
            // Initialize the detail map
            setTimeout(() => {
                const detailMap = new google.maps.Map(document.getElementById('serviceDetailMap'), {
                    center: { lat: service.latitude, lng: service.longitude },
                    zoom: 15,
                    mapTypeControl: false,
                    streetViewControl: false
                });
                
                new google.maps.Marker({
                    position: { lat: service.latitude, lng: service.longitude },
                    map: detailMap,
                    title: service.name
                });
            }, 500);
        }
        
        function initializeMap() {
            // Create map
            map = new google.maps.Map(document.getElementById('servicesMap'), {
                center: { lat: 20.5937, lng: 78.9629 }, // Center of India
                zoom: 5,
                mapTypeControl: false,
                fullscreenControl: true,
                streetViewControl: true,
                zoomControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        "featureType": "administrative",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#444444"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{"color": "#f2f2f2"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [{"saturation": -100}, {"lightness": 45}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{"visibility": "simplified"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [{"color": "#c4e5f9"}, {"visibility": "on"}]
                    }
                ]
            });
            
            // Create info window for markers
            infoWindow = new google.maps.InfoWindow();
            
            // Add map legend
            const legend = document.createElement('div');
            legend.className = 'map-legend';
            legend.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">Service Types</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <div>Health</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <div>Education</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <div>Government</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                    <div>Security</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <div>Transport</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #1abc9c;"></div>
                    <div>Financial</div>
                </div>
            `;
            
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
            
            // Add custom control for current location
            const locationControl = document.createElement('div');
            locationControl.className = 'map-control';
            locationControl.innerHTML = `
                <button id="mapLocationBtn" style="background: none; border: none; cursor: pointer; display: flex; align-items: center;">
                    <i class="fas fa-location-arrow" style="color: #3498db; margin-right: 8px;"></i>
                    <span>My Location</span>
                </button>
            `;
            
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(locationControl);
            
            // Add event listener for location control
            document.getElementById('mapLocationBtn').addEventListener('click', function() {
                if (currentLocation) {
                    map.setCenter(currentLocation);
                    map.setZoom(14);
                } else {
                    useLocationBtn.click();
                }
            });
        }
        
        function addMarkersToMap(services) {
            clearMarkers();
            
            const bounds = new google.maps.LatLngBounds();
            
            // Add user location marker
            if (currentLocation) {
                const userMarker = new google.maps.Marker({
                    position: { lat: currentLocation.lat, lng: currentLocation.lng },
                    map: map,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2
                    }
                });
                
                markers.push(userMarker);
                bounds.extend(userMarker.getPosition());
                
                // Add circle for radius
                const radiusCircle = new google.maps.Circle({
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#4285F4',
                    fillOpacity: 0.1,
                    map: map,
                    center: { lat: currentLocation.lat, lng: currentLocation.lng },
                    radius: currentRadius * 1000 // Convert km to meters
                });
                
                markers.push(radiusCircle);
            }
            
            // Add service markers
            services.forEach(service => {
                const marker = new google.maps.Marker({
                    position: { lat: service.latitude, lng: service.longitude },
                    map: map,
                    title: service.name,
                    icon: getMarkerIcon(service.type),
                    animation: google.maps.Animation.DROP
                });
                
                const infoContent = `
                    <div style="max-width: 250px; padding: 5px;">
                        <h6 style="margin-bottom: 5px; font-weight: 600;">${service.name}</h6>
                        <p style="font-size: 12px; margin-bottom: 5px; color: #666;">${service.address}</p>
                        <p style="font-size: 12px; margin-bottom: 10px; color: #3498db; font-weight: 600;">
                            <i class="fas fa-route"></i> ${service.distance.toFixed(1)} km away
                        </p>
                        <div style="display: flex; gap: 5px;">
                            <button class="view-on-map" data-service-id="${service.id}" style="font-size: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 4px 8px; cursor: pointer;">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            <a href="${service.map_link}" target="_blank" style="font-size: 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; padding: 4px 8px; text-decoration: none; display: inline-block;">
                                <i class="fas fa-directions"></i> Directions
                            </a>
                        </div>
                    </div>
                `;
                
                marker.addListener('click', function() {
                    // Close any open info windows
                    if (infoWindow) {
                        infoWindow.close();
                    }
                    
                    infoWindow.setContent(infoContent);
                    infoWindow.open(map, marker);
                    
                    // Add event listener to the details button in info window
                    setTimeout(() => {
                        const detailBtn = document.querySelector('.view-on-map[data-service-id="' + service.id + '"]');
                        if (detailBtn) {
                            detailBtn.addEventListener('click', function() {
                                const serviceId = parseInt(this.dataset.serviceId);
                                const serviceObj = servicesData.find(s => s.id === serviceId);
                                if (serviceObj) {
                                    showServiceDetails(serviceObj);
                                }
                            });
                        }
                    }, 100);
                });
                
                markers.push(marker);
                bounds.extend(marker.getPosition());
            });
            
            // Fit map to bounds
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
                
                // Don't zoom in too far on small data sets
                const listener = google.maps.event.addListener(map, 'idle', function() {
                    if (map.getZoom() > 16) {
                        map.setZoom(16);
                    }
                    google.maps.event.removeListener(listener);
                });
            }
        }
        
        function getMarkerIcon(type) {
            let icon = '';
            let color = '';
            
            switch(type) {
                case 'health':
                    icon = 'hospital';
                    color = '#e74c3c';
                    break;
                case 'education':
                    icon = 'school';
                    color = '#f39c12';
                    break;
                case 'government':
                    icon = 'landmark';
                    color = '#3498db';
                    break;
                case 'security':
                    icon = 'shield-alt';
                    color = '#2ecc71';
                    break;
                case 'transport':
                    icon = 'bus';
                    color = '#9b59b6';
                    break;
                case 'financial':
                    icon = 'university';
                    color = '#1abc9c';
                    break;
                default:
                    icon = 'building';
                    color = '#6c757d';
            }
            
            return {
                url: `https://api.iconify.design/fa-solid/${icon}.svg?color=${encodeURIComponent(color)}&width=32&height=32`,
                scaledSize: new google.maps.Size(32, 32)
            };
        }
        
        function clearMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
        }
    });
</script>
{% endblock %}