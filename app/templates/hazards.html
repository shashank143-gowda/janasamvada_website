{% extends 'base.html' %}

{% block title %}Hazards Reporting - JanSamvaad{% endblock %}

{% block extra_css %}
<style>
    .hazard-header {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 60px 0;
        border-radius: 0 0 50px 50px;
        margin-bottom: 40px;
    }
    
    .hazard-card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        height: 100%;
        border: none;
        background-color: #fff;
        position: relative;
    }
    
    .hazard-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    
    .hazard-card .card-img-top {
        height: 180px;
        object-fit: cover;
        transition: all 0.5s ease;
    }
    
    .hazard-card:hover .card-img-top {
        transform: scale(1.05);
    }
    
    .hazard-card .card-body {
        padding: 1.25rem;
        position: relative;
    }
    
    .hazard-card .card-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #2c3e50;
        font-size: 1.1rem;
        line-height: 1.4;
    }
    
    .hazard-card .card-text {
        color: #555;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    
    .hazard-card .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 180px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.5) 100%);
        opacity: 0.7;
        transition: all 0.3s ease;
    }
    
    .hazard-card:hover .image-overlay {
        opacity: 0.5;
    }
    
    .hazard-type {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 10;
    }
    
    .hazard-status {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 10;
    }
    
    .status-pending {
        background-color: #f39c12;
        color: white;
    }
    
    .status-in-progress {
        background-color: #3498db;
        color: white;
    }
    
    .status-resolved {
        background-color: #2ecc71;
        color: white;
    }
    
    .type-road {
        background-color: #9b59b6;
        color: white;
    }
    
    .type-water {
        background-color: #3498db;
        color: white;
    }
    
    .type-electricity {
        background-color: #f1c40f;
        color: white;
    }
    
    .type-other {
        background-color: #95a5a6;
        color: white;
    }
    
    .upvote-btn {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
        color: #555;
        font-weight: 500;
    }
    
    .upvote-btn:hover {
        background-color: #e74c3c;
        color: white;
        border-color: #e74c3c;
    }
    
    .upvote-btn i {
        font-size: 0.8rem;
    }
    
    .avatar-circle {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }
    
    .location-badge {
        display: inline-flex;
        align-items: center;
        background-color: #f8f9fa;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        color: #555;
    }
    
    .report-btn {
        border-radius: 30px;
        padding: 12px 30px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }
    
    .report-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .report-btn i {
        margin-right: 8px;
    }
    
    .filter-card {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: none;
    }
    
    .filter-card .card-header {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
    }
    
    .filter-btn {
        background-color: #e74c3c;
        border: none;
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    
    .filter-btn:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
    }
    
    .map-container {
        height: 400px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .voice-report-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .voice-report-btn:hover {
        transform: scale(1.1);
    }
    
    .voice-report-btn.recording {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(231, 76, 60, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
        }
    }
    
    .voice-report-modal .modal-content {
        border-radius: 15px;
        overflow: hidden;
    }
    
    .voice-report-modal .modal-header {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
    }
    
    .voice-report-modal .modal-footer {
        border: none;
    }
    
    .voice-visualizer {
        height: 100px;
        width: 100%;
        background-color: #f8f9fa;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    
    .voice-visualizer-bars {
        display: flex;
        align-items: flex-end;
        height: 100%;
        padding: 0 10px;
    }
    
    .visualizer-bar {
        background-color: #e74c3c;
        width: 5px;
        margin: 0 2px;
        border-radius: 5px 5px 0 0;
        transition: height 0.1s ease;
    }
    
    .language-toggle {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1000;
        background-color: white;
        border-radius: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        padding: 5px;
        display: flex;
        flex-direction: column;
    }
    
    .language-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 5px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .language-btn.active {
        background-color: #e74c3c;
        color: white;
    }
    
    .language-btn:not(.active) {
        background-color: #f8f9fa;
        color: #333;
    }
    
    .language-btn:hover:not(.active) {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Language Toggle -->
<div class="language-toggle">
    <button class="language-btn active" data-lang="en" title="English">EN</button>
    <button class="language-btn" data-lang="kn" title="ಕನ್ನಡ">ಕ</button>
</div>

<!-- Voice Report Button -->
<button class="voice-report-btn" id="voiceReportBtn" title="Report hazard using voice">
    <i class="fas fa-microphone"></i>
</button>

<!-- Header Section -->
<section class="hazard-header">
    <div class="container text-center">
        <h1 class="display-4 fw-bold mb-3 animate__animated animate__fadeInDown" data-translate="hazards-title">Hazards Reporting</h1>
        <p class="lead mb-4 animate__animated animate__fadeInUp" data-translate="hazards-subtitle">Report and track hazards in your community to ensure quick resolution</p>
        <div class="d-flex justify-content-center">
            <a href="{{ url_for('hazards_bp.report_hazard_page') }}" class="btn report-btn animate__animated animate__fadeInUp">
                <i class="fas fa-exclamation-triangle"></i> <span data-translate="report-hazard">Report a Hazard</span>
            </a>
        </div>
    </div>
</section>

<div class="container">
    <div class="row">
        <!-- Filters Section -->
        <div class="col-lg-3 mb-4">
            <div class="filter-card" data-aos="fade-right">
                <div class="card-header">
                    <h5 class="mb-0" data-translate="filter-hazards">Filter Hazards</h5>
                </div>
                <div class="card-body">
                    <form id="filter-form">
                        <div class="mb-3">
                            <label for="hazard-type" class="form-label" data-translate="hazard-type">Hazard Type</label>
                            <select class="form-select" id="hazard-type">
                                <option value="" data-translate="all-types">All Types</option>
                                <option value="road" data-translate="road">Road</option>
                                <option value="water" data-translate="water">Water</option>
                                <option value="electricity" data-translate="electricity">Electricity</option>
                                <option value="other" data-translate="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="hazard-status" class="form-label" data-translate="status">Status</label>
                            <select class="form-select" id="hazard-status">
                                <option value="" data-translate="all-statuses">All Statuses</option>
                                <option value="pending" data-translate="pending">Pending</option>
                                <option value="in-progress" data-translate="in-progress">In Progress</option>
                                <option value="resolved" data-translate="resolved">Resolved</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="location-filter" class="form-label" data-translate="location">Location</label>
                            <input type="text" class="form-control" id="location-filter" placeholder="Enter location">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn filter-btn" data-translate="apply-filters">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Statistics Card -->
            <div class="filter-card" data-aos="fade-right" data-aos-delay="100">
                <div class="card-header">
                    <h5 class="mb-0" data-translate="statistics">Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span data-translate="total-hazards">Total Hazards</span>
                        <span class="fw-bold" id="total-hazards">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span data-translate="pending">Pending</span>
                        <span class="fw-bold text-warning" id="pending-hazards">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span data-translate="in-progress">In Progress</span>
                        <span class="fw-bold text-primary" id="in-progress-hazards">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span data-translate="resolved">Resolved</span>
                        <span class="fw-bold text-success" id="resolved-hazards">0</span>
                    </div>
                </div>
            </div>
            
            <!-- News Section -->
            <div class="filter-card" data-aos="fade-right" data-aos-delay="200">
                <div class="card-header">
                    <h5 class="mb-0" data-translate="local-news">Local News</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="news-list">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted" data-translate="loading-news">Loading local news...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hazards List Section -->
        <div class="col-lg-9">
            <!-- Map View -->
            <div class="mb-4" data-aos="fade-up">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 data-translate="hazards-map">Hazards Map</h4>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="map-view-btn" data-translate="map-view">Map View</button>
                        <button type="button" class="btn btn-outline-primary" id="list-view-btn" data-translate="list-view">List View</button>
                    </div>
                </div>
                <div class="map-container" id="hazards-map"></div>
            </div>
            
            <!-- Hazards List -->
            <div id="hazards-list" style="display: none;">
                <div class="row" id="hazards-container">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted" data-translate="loading-hazards">Loading hazards...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Hazards pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Voice Report Modal -->
<div class="modal fade voice-report-modal" id="voiceReportModal" tabindex="-1" aria-labelledby="voiceReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="voiceReportModalLabel" data-translate="voice-report">Voice Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-center mb-4" data-translate="voice-instructions">Speak clearly to report a hazard. We'll convert your voice to text.</p>
                
                <div class="voice-visualizer mb-4">
                    <div class="voice-visualizer-bars" id="voice-visualizer-bars">
                        <!-- Visualizer bars will be generated dynamically -->
                    </div>
                </div>
                
                <div class="text-center mb-4">
                    <button class="btn btn-lg btn-danger rounded-circle" id="recordButton">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <p class="mt-2" id="recordingStatus" data-translate="click-to-start">Click to start recording</p>
                </div>
                
                <div class="mb-3">
                    <label for="voiceTranscript" class="form-label" data-translate="transcript">Transcript</label>
                    <textarea class="form-control" id="voiceTranscript" rows="4" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitVoiceReport" disabled data-translate="submit-report">Submit Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDf8fmG-LH14KqvPA33y-ZCKqBFhmWzD0s&callback=initMap" async defer></script>
<script>
    // Initialize variables
    let map;
    let markers = [];
    let hazardsData = [];
    let currentLanguage = 'en';
    let translations = {
        'en': {
            'hazards-title': 'Hazards Reporting',
            'hazards-subtitle': 'Report and track hazards in your community to ensure quick resolution',
            'report-hazard': 'Report a Hazard',
            'filter-hazards': 'Filter Hazards',
            'hazard-type': 'Hazard Type',
            'all-types': 'All Types',
            'road': 'Road',
            'water': 'Water',
            'electricity': 'Electricity',
            'other': 'Other',
            'status': 'Status',
            'processing': 'Processing your speech...',
            'recording-complete': 'Recording complete!',
            'recording-error': 'Error processing speech',
        },
        'kn': {
            'hazards-title': 'ಅಪಾಯಗಳ ವರದಿ',
            'hazards-subtitle': 'ತ್ವರಿತ ಪರಿಹಾರವನ್ನು ಖಚಿತಪಡಿಸಿಕೊಳ್ಳಲು ನಿಮ್ಮ ಸಮುದಾಯದಲ್ಲಿನ ಅಪಾಯಗಳನ್ನು ವರದಿ ಮಾಡಿ ಮತ್ತು ಟ್ರ್ಯಾಕ್ ಮಾಡಿ',
            'report-hazard': 'ಅಪಾಯವನ್ನು ವರದಿ ಮಾಡಿ',
            'filter-hazards': 'ಅಪಾಯಗಳನ್ನು ಫಿಲ್ಟರ್ ಮಾಡಿ',
            'hazard-type': 'ಅಪಾಯದ ಪ್ರಕಾರ',
            'all-types': 'ಎಲ್ಲಾ ಪ್ರಕಾರಗಳು',
            'road': 'ರಸ್ತೆ',
            'water': 'ನೀರು',
            'electricity': 'ವಿದ್ಯುತ್',
            'other': 'ಇತರೆ',
            'status': 'ಸ್ಥಿತಿ',
            'processing': 'ನಿಮ್ಮ ಮಾತನ್ನು ಸಂಸ್ಕರಿಸಲಾಗುತ್ತಿದೆ...',
            'recording-complete': 'ರೆಕಾರ್ಡಿಂಗ್ ಪೂರ್ಣಗೊಂಡಿದೆ!',
            'recording-error': 'ಮಾತನ್ನು ಸಂಸ್ಕರಿಸುವಲ್ಲಿ ದೋಷ',
            'all-statuses': 'ಎಲ್ಲಾ ಸ್ಥಿತಿಗಳು',
            'pending': 'ಬಾಕಿ ಇದೆ',
            'in-progress': 'ಪ್ರಗತಿಯಲ್ಲಿದೆ',
            'resolved': 'ಪರಿಹರಿಸಲಾಗಿದೆ',
            'location': 'ಸ್ಥಳ',
            'apply-filters': 'ಫಿಲ್ಟರ್‌ಗಳನ್ನು ಅನ್ವಯಿಸಿ',
            'statistics': 'ಅಂಕಿಅಂಶಗಳು',
            'total-hazards': 'ಒಟ್ಟು ಅಪಾಯಗಳು',
            'local-news': 'ಸ್ಥಳೀಯ ಸುದ್ದಿ',
            'loading-news': 'ಸ್ಥಳೀಯ ಸುದ್ದಿಯನ್ನು ಲೋಡ್ ಮಾಡಲಾಗುತ್ತಿದೆ...',
            'hazards-map': 'ಅಪಾಯಗಳ ನಕ್ಷೆ',
            'map-view': 'ನಕ್ಷೆ ನೋಟ',
            'list-view': 'ಪಟ್ಟಿ ನೋಟ',
            'loading-hazards': 'ಅಪಾಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಲಾಗುತ್ತಿದೆ...',
            'voice-report': 'ಧ್ವನಿ ವರದಿ',
            'voice-instructions': 'ಅಪಾಯವನ್ನು ವರದಿ ಮಾಡಲು ಸ್ಪಷ್ಟವಾಗಿ ಮಾತನಾಡಿ. ನಾವು ನಿಮ್ಮ ಧ್ವನಿಯನ್ನು ಪಠ್ಯಕ್ಕೆ ಪರಿವರ್ತಿಸುತ್ತೇವೆ.',
            'click-to-start': 'ರೆಕಾರ್ಡಿಂಗ್ ಪ್ರಾರಂಭಿಸಲು ಕ್ಲಿಕ್ ಮಾಡಿ',
            'recording': 'ರೆಕಾರ್ಡಿಂಗ್...',
            'processing': 'ಸಂಸ್ಕರಿಸಲಾಗುತ್ತಿದೆ...',
            'transcript': 'ಪ್ರತಿಲಿಪಿ',
            'cancel': 'ರದ್ದುಮಾಡಿ',
            'submit-report': 'ವರದಿ ಸಲ್ಲಿಸಿ',
            'upvote': 'ಅಪ್‌ವೋಟ್',
            'view-details': 'ವಿವರಗಳನ್ನು ವೀಕ್ಷಿಸಿ',
            'reported-by': 'ವರದಿ ಮಾಡಿದವರು',
            'on': 'ರಂದು',
            'no-hazards': 'ನಿಮ್ಮ ಮಾನದಂಡಗಳಿಗೆ ಹೊಂದಿಕೆಯಾಗುವ ಯಾವುದೇ ಅಪಾಯಗಳು ಕಂಡುಬಂದಿಲ್ಲ.',
        },
            'all-statuses': 'All Statuses',
            'pending': 'Pending',
            'in-progress': 'In Progress',
            'resolved': 'Resolved',
            'location': 'Location',
            'apply-filters': 'Apply Filters',
            'statistics': 'Statistics',
            'total-hazards': 'Total Hazards',
            'local-news': 'Local News',
            'loading-news': 'Loading local news...',
            'hazards-map': 'Hazards Map',
            'map-view': 'Map View',
            'list-view': 'List View',
            'loading-hazards': 'Loading hazards...',
            'voice-report': 'Voice Report',
            'voice-instructions': 'Speak clearly to report a hazard. We\'ll convert your voice to text.',
            'click-to-start': 'Click to start recording',
            'recording': 'Recording...',
            'processing': 'Processing...',
            'transcript': 'Transcript',
            'cancel': 'Cancel',
            'submit-report': 'Submit Report',
            'upvote': 'Upvote',
            'view-details': 'View Details',
            'reported-by': 'Reported by',
            'on': 'on',
            'no-hazards': 'No hazards found matching your criteria.',
            'location-not-available': 'Location not available',
            'news-title': 'Local News',
            'no-news': 'No local news available at the moment.'
        },
        'kn': {
            'hazards-title': 'ಅಪಾಯಗಳ ವರದಿ',
            'hazards-subtitle': 'ತ್ವರಿತ ಪರಿಹಾರವನ್ನು ಖಚಿತಪಡಿಸಲು ನಿಮ್ಮ ಸಮುದಾಯದಲ್ಲಿನ ಅಪಾಯಗಳನ್ನು ವರದಿ ಮಾಡಿ ಮತ್ತು ಟ್ರ್ಯಾಕ್ ಮಾಡಿ',
            'report-hazard': 'ಅಪಾಯವನ್ನು ವರದಿ ಮಾಡಿ',
            'filter-hazards': 'ಅಪಾಯಗಳನ್ನು ಫಿಲ್ಟರ್ ಮಾಡಿ',
            'hazard-type': 'ಅಪಾಯದ ಪ್ರಕಾರ',
            'all-types': 'ಎಲ್ಲಾ ಪ್ರಕಾರಗಳು',
            'road': 'ರಸ್ತೆ',
            'water': 'ನೀರು',
            'electricity': 'ವಿದ್ಯುತ್',
            'other': 'ಇತರೆ',
            'status': 'ಸ್ಥಿತಿ',
            'all-statuses': 'ಎಲ್ಲಾ ಸ್ಥಿತಿಗಳು',
            'pending': 'ಬಾಕಿ ಇದೆ',
            'in-progress': 'ಪ್ರಗತಿಯಲ್ಲಿದೆ',
            'resolved': 'ಪರಿಹರಿಸಲಾಗಿದೆ',
            'location': 'ಸ್ಥಳ',
            'apply-filters': 'ಫಿಲ್ಟರ್‌ಗಳನ್ನು ಅನ್ವಯಿಸಿ',
            'statistics': 'ಅಂಕಿಅಂಶಗಳು',
            'total-hazards': 'ಒಟ್ಟು ಅಪಾಯಗಳು',
            'local-news': 'ಸ್ಥಳೀಯ ಸುದ್ದಿ',
            'loading-news': 'ಸ್ಥಳೀಯ ಸುದ್ದಿಗಳನ್ನು ಲೋಡ್ ಮಾಡಲಾಗುತ್ತಿದೆ...',
            'hazards-map': 'ಅಪಾಯಗಳ ನಕ್ಷೆ',
            'map-view': 'ನಕ್ಷೆ ನೋಟ',
            'list-view': 'ಪಟ್ಟಿ ನೋಟ',
            'loading-hazards': 'ಅಪಾಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಲಾಗುತ್ತಿದೆ...',
            'voice-report': 'ಧ್ವನಿ ವರದಿ',
            'voice-instructions': 'ಅಪಾಯವನ್ನು ವರದಿ ಮಾಡಲು ಸ್ಪಷ್ಟವಾಗಿ ಮಾತನಾಡಿ. ನಾವು ನಿಮ್ಮ ಧ್ವನಿಯನ್ನು ಪಠ್ಯಕ್ಕೆ ಪರಿವರ್ತಿಸುತ್ತೇವೆ.',
            'click-to-start': 'ರೆಕಾರ್ಡಿಂಗ್ ಪ್ರಾರಂಭಿಸಲು ಕ್ಲಿಕ್ ಮಾಡಿ',
            'recording': 'ರೆಕಾರ್ಡಿಂಗ್...',
            'processing': 'ಪ್ರಕ್ರಿಯೆಗೊಳಿಸಲಾಗುತ್ತಿದೆ...',
            'transcript': 'ಪ್ರತಿಲಿಪಿ',
            'cancel': 'ರದ್ದುಮಾಡಿ',
            'submit-report': 'ವರದಿ ಸಲ್ಲಿಸಿ',
            'upvote': 'ಅಪ್‌ವೋಟ್',
            'view-details': 'ವಿವರಗಳನ್ನು ವೀಕ್ಷಿಸಿ',
            'reported-by': 'ವರದಿ ಮಾಡಿದವರು',
            'on': 'ರಂದು',
            'no-hazards': 'ನಿಮ್ಮ ಮಾನದಂಡಗಳಿಗೆ ಹೊಂದಿಕೆಯಾಗುವ ಯಾವುದೇ ಅಪಾಯಗಳು ಕಂಡುಬಂದಿಲ್ಲ.',
            'location-not-available': 'ಸ್ಥಳ ಲಭ್ಯವಿಲ್ಲ',
            'news-title': 'ಸ್ಥಳೀಯ ಸುದ್ದಿ',
            'no-news': 'ಪ್ರಸ್ತುತ ಯಾವುದೇ ಸ್ಥಳೀಯ ಸುದ್ದಿಗಳು ಲಭ್ಯವಿಲ್ಲ.'
        }
    };
    
    // Initialize map
    function initMap() {
        map = new google.maps.Map(document.getElementById('hazards-map'), {
            center: { lat: 12.9716, lng: 77.5946 }, // Bangalore coordinates
            zoom: 12
        });
        
        // Load hazards data
        loadHazards();
    }
    
    // Load hazards from API
    function loadHazards(type = '', status = '', location = '') {
        // Clear existing markers
        clearMarkers();
        
        // Show loading state
        $('#hazards-container').html(`
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">${getTranslation('loading-hazards')}</p>
            </div>
        `);
        
        // Fetch hazards data from API
        $.ajax({
            url: '{{ url_for("hazards_bp.get_hazards") }}',
            method: 'GET',
            data: {
                type: type,
                status: status,
                location: location
            },
            success: function(response) {
                if (response.success) {
                    hazardsData = response.hazards;
                    
                    // Update statistics
                    updateStatistics(hazardsData);
                    
                    // Display hazards on map
                    displayHazardsOnMap(hazardsData);
                    
                    // Display hazards in list
                    displayHazardsList(hazardsData);
                }
            },
            error: function(xhr) {
                console.error('Error loading hazards:', xhr);
                $('#hazards-container').html(`
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                        <p>Error loading hazards. Please try again later.</p>
                    </div>
                `);
            }
        });
        
        // Load local news
        loadLocalNews();
    }
    
    // Display hazards on map
    function displayHazardsOnMap(hazards) {
        clearMarkers();
        
        hazards.forEach(hazard => {
            if (hazard.latitude && hazard.longitude) {
                const marker = new google.maps.Marker({
                    position: { lat: hazard.latitude, lng: hazard.longitude },
                    map: map,
                    title: hazard.title,
                    icon: getMarkerIcon(hazard.status)
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="max-width: 300px;">
                            <h5>${hazard.title}</h5>
                            <p>${hazard.description.substring(0, 100)}${hazard.description.length > 100 ? '...' : ''}</p>
                            <p><strong>Type:</strong> ${hazard.hazard_type}</p>
                            <p><strong>Status:</strong> ${hazard.status}</p>
                            <p><strong>Reported by:</strong> ${hazard.username}</p>
                            <a href="/hazards/details/${hazard.id}" class="btn btn-sm btn-primary">View Details</a>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                markers.push(marker);
            }
        });
        
        // Adjust map bounds to fit all markers
        if (markers.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            markers.forEach(marker => bounds.extend(marker.getPosition()));
            map.fitBounds(bounds);
        }
    }
    
    // Get marker icon based on status
    function getMarkerIcon(status) {
        switch (status) {
            case 'pending':
                return 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
            case 'in-progress':
                return 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
            case 'resolved':
                return 'https://maps.google.com/mapfiles/ms/icons/green-dot.png';
            default:
                return 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
        }
    }
    
    // Clear all markers from map
    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }
    
    // Display hazards in list view
    function displayHazardsList(hazards) {
        if (hazards.length === 0) {
            $('#hazards-container').html(`
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <p class="text-muted">${getTranslation('no-hazards')}</p>
                </div>
            `);
            return;
        }
        
        let html = '';
        
        hazards.forEach(hazard => {
            html += `
                <div class="col-md-6 col-lg-4 mb-4" data-aos="fade-up">
                    <div class="hazard-card">
                        <div class="position-relative">
                            <div class="image-overlay"></div>
                            <span class="hazard-status status-${hazard.status}">${getTranslation(hazard.status)}</span>
                            <span class="hazard-type type-${hazard.hazard_type}">${getTranslation(hazard.hazard_type)}</span>
                            <img src="${hazard.image_path || 'https://via.placeholder.com/300x200?text=No+Image'}" class="card-img-top" alt="${hazard.title}">
                            <div class="position-absolute bottom-0 start-0 w-100 p-3 text-white">
                                <h5 class="mb-0 text-white fw-bold">${hazard.title}</h5>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-light me-2">
                                        <i class="fas fa-user text-secondary"></i>
                                    </div>
                                    <span class="small fw-medium">${hazard.username}</span>
                                </div>
                                <span class="text-muted small">
                                    <i class="fas fa-calendar-alt me-1"></i> ${new Date(hazard.created_at).toLocaleDateString()}
                                </span>
                            </div>
                            
                            <p class="card-text">${hazard.description.substring(0, 100)}${hazard.description.length > 100 ? '...' : ''}</p>
                            
                            <div class="location-badge mb-3">
                                <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                                <span class="small">${hazard.location_description || getTranslation('location-not-available')}</span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="upvote-btn" data-id="${hazard.id}">
                                    <i class="fas fa-arrow-up"></i> ${hazard.upvotes}
                                </button>
                                <a href="/hazards/details/${hazard.id}" class="btn btn-sm btn-primary rounded-pill px-3">
                                    <i class="fas fa-info-circle me-1"></i> ${getTranslation('view-details')}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $('#hazards-container').html(html);
        
        // Initialize upvote buttons
        $('.upvote-btn').click(function() {
            const hazardId = $(this).data('id');
            upvoteHazard(hazardId);
        });
    }
    
    // Update statistics
    function updateStatistics(hazards) {
        const total = hazards.length;
        const pending = hazards.filter(h => h.status === 'pending').length;
        const inProgress = hazards.filter(h => h.status === 'in-progress').length;
        const resolved = hazards.filter(h => h.status === 'resolved').length;
        
        $('#total-hazards').text(total);
        $('#pending-hazards').text(pending);
        $('#in-progress-hazards').text(inProgress);
        $('#resolved-hazards').text(resolved);
    }
    
    // Upvote a hazard
    function upvoteHazard(hazardId) {
        $.ajax({
            url: `/api/hazards/${hazardId}/upvote`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    // Reload hazards to update the UI
                    loadHazards(
                        $('#hazard-type').val(),
                        $('#hazard-status').val(),
                        $('#location-filter').val()
                    );
                }
            }
        });
    }
    
    // Load local news based on user location
    function loadLocalNews() {
        // This would typically call an API to get local news
        // For demo purposes, we'll use dummy data
        const dummyNews = [
            {
                title: 'Road repairs scheduled for MG Road',
                date: '2023-07-15',
                source: 'Bangalore Times'
            },
            {
                title: 'Water supply interruption in Indiranagar',
                date: '2023-07-14',
                source: 'City News'
            },
            {
                title: 'New traffic regulations in Electronic City',
                date: '2023-07-13',
                source: 'Traffic Updates'
            },
            {
                title: 'Power outage planned for maintenance in Koramangala',
                date: '2023-07-12',
                source: 'BESCOM'
            }
        ];
        
        let html = '';
        
        if (dummyNews.length === 0) {
            html = `
                <div class="text-center py-3">
                    <p class="text-muted">${getTranslation('no-news')}</p>
                </div>
            `;
        } else {
            dummyNews.forEach(news => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${news.title}</h6>
                            <small>${news.date}</small>
                        </div>
                        <small class="text-muted">${news.source}</small>
                    </a>
                `;
            });
        }
        
        $('#news-list').html(html);
    }
    
    // Voice recognition functionality using Dhvani API
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    
    // Check if browser supports MediaRecorder
    const hasMediaRecorderSupport = 'MediaRecorder' in window;
    
    function startRecording() {
        if (!hasMediaRecorderSupport) {
            alert('Your browser does not support audio recording. Please use a modern browser like Chrome or Firefox.');
            return;
        }
        
        // Request microphone access
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                isRecording = true;
                $('#recordingStatus').text(getTranslation('recording'));
                $('#recordButton').html('<i class="fas fa-stop"></i>');
                $('#recordButton').addClass('btn-danger').removeClass('btn-primary');
                startVisualizer();
                
                // Create media recorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                // Handle data available event
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                // Handle recording stop
                mediaRecorder.onstop = () => {
                    // Convert audio chunks to blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // Show processing message
                    $('#recordingStatus').text(getTranslation('processing'));
                    
                    // Convert blob to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        
                        // Send to our Dhvani API endpoint
                        $.ajax({
                            url: '/speech/api/speech-to-text',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                audio_data: base64Audio,
                                language: currentLanguage
                            }),
                            success: function(response) {
                                if (response.success && response.transcript) {
                                    $('#voiceTranscript').val(response.transcript);
                                    $('#submitVoiceReport').prop('disabled', false);
                                    $('#recordingStatus').text(getTranslation('recording-complete'));
                                } else {
                                    $('#recordingStatus').text(getTranslation('recording-error'));
                                    console.error('Transcription error:', response.error);
                                }
                            },
                            error: function(xhr, status, error) {
                                $('#recordingStatus').text(getTranslation('recording-error'));
                                console.error('API error:', error);
                            }
                        });
                    };
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                // Start recording
                mediaRecorder.start();
                
                // Set a maximum recording time (30 seconds)
                setTimeout(() => {
                    if (isRecording) {
                        stopRecording();
                    }
                }, 30000);
            })
            .catch(error => {
                console.error('Error accessing microphone:', error);
                alert('Error accessing microphone. Please ensure you have granted microphone permissions.');
            });
    }
    
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            $('#recordButton').html('<i class="fas fa-microphone"></i>');
            $('#recordButton').removeClass('btn-danger').addClass('btn-primary');
            stopVisualizer();
        }
    }
    
    // Voice visualizer
    let visualizerInterval;
    
    function startVisualizer() {
        // Create visualizer bars
        const visualizerContainer = $('#voice-visualizer-bars');
        visualizerContainer.empty();
        
        for (let i = 0; i < 30; i++) {
            visualizerContainer.append('<div class="visualizer-bar"></div>');
        }
        
        // Animate bars
        visualizerInterval = setInterval(() => {
            $('.visualizer-bar').each(function() {
                const height = Math.floor(Math.random() * 100);
                $(this).css('height', height + '%');
            });
        }, 100);
    }
    
    function stopVisualizer() {
        clearInterval(visualizerInterval);
        $('.visualizer-bar').css('height', '0%');
    }
    
    // Language translation functions
    function switchLanguage(lang) {
        currentLanguage = lang;
        
        // Update all translatable elements
        $('[data-translate]').each(function() {
            const key = $(this).attr('data-translate');
            $(this).text(getTranslation(key));
        });
        
        // Update placeholders
        $('[data-translate-placeholder]').each(function() {
            const key = $(this).attr('data-translate-placeholder');
            $(this).attr('placeholder', getTranslation(key));
        });
        
        // Update language buttons
        $('.language-btn').removeClass('active');
        $(`.language-btn[data-lang="${lang}"]`).addClass('active');
        
        // Refresh hazards list to update translations
        displayHazardsList(hazardsData);
    }
    
    function getTranslation(key) {
        return translations[currentLanguage][key] || key;
    }
    
    // Document ready
    $(document).ready(function() {
        // Initialize language
        switchLanguage('en');
        
        // Filter form submission
        $('#filter-form').on('submit', function(e) {
            e.preventDefault();
            
            const type = $('#hazard-type').val();
            const status = $('#hazard-status').val();
            const location = $('#location-filter').val();
            
            loadHazards(type, status, location);
        });
        
        // View toggle buttons
        $('#map-view-btn').click(function() {
            $(this).addClass('active');
            $('#list-view-btn').removeClass('active');
            $('#hazards-map').show();
            $('#hazards-list').hide();
        });
        
        $('#list-view-btn').click(function() {
            $(this).addClass('active');
            $('#map-view-btn').removeClass('active');
            $('#hazards-map').hide();
            $('#hazards-list').show();
        });
        
        // Voice report button
        $('#voiceReportBtn').click(function() {
            $('#voiceReportModal').modal('show');
        });
        
        // Record button
        $('#recordButton').click(function() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });
        
        // Submit voice report
        $('#submitVoiceReport').click(function() {
            const transcript = $('#voiceTranscript').val();
            
            // Process the transcript to extract hazard information
            // This would typically involve NLP or a structured approach
            // For demo purposes, we'll just show an alert
            alert('Voice report submitted: ' + transcript);
            
            // Close the modal
            $('#voiceReportModal').modal('hide');
            
            // Reset the form
            $('#voiceTranscript').val('');
            $('#submitVoiceReport').prop('disabled', true);
        });
        
        // Language toggle
        $('.language-btn').click(function() {
            const lang = $(this).data('lang');
            switchLanguage(lang);
        });
        
        // Initialize map when Google Maps API is loaded
        window.initMap = initMap;
    });
</script>
{% endblock %}